<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>True Symmetry - Dynamic Axis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #ui { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 100; }
        button { padding: 15px 25px; border-radius: 50px; border: 2px solid #fff; background: rgba(0,0,0,0.8); color: #fff; font-weight: bold; }
    </style>
</head>
<body>
<script>
let capture, faceMesh, face;
let mode = 'left'; // איזה צד לשכפל

function preload() {
    faceMesh = ml5.faceMesh({ maxFaces: 1, flipped: false });
}

function setup() {
    createCanvas(windowWidth, windowHeight);
    capture = createCapture({ video: { facingMode: "user" }, audio: false });
    capture.size(640, 480);
    capture.hide();
    faceMesh.detectStart(capture, (results) => { face = results[0]; });
}

function draw() {
    background(0);
    if (!face || !face.keypoints) return;

    // 1. מציאת האף (הציר הדינמי)
    let nose = face.keypoints[1];
    let nx = nose.x; 
    let vW = capture.width;
    let vH = capture.height;

    // 2. חישוב קנה מידה למילוי המסך
    let s = height / vH;
    
    // 3. חישוב מיקום האף על המסך הפיזי
    let screenNoseX = nx * s;

    // אנחנו מזיזים את כל הציור כך שהאף תמיד יהיה במרכז המסך הפיזי
    let globalOffset = (width / 2) - screenNoseX;
    push();
    translate(globalOffset, 0);

    if (mode === 'left') {
        // --- צד שמאל המקורי (נגזר מהאף שמאלה) ---
        // (תמונה, יעד_X, יעד_Y, יעד_רוחב, יעד_גובה, מקור_X, מקור_Y, מקור_רוחב, מקור_גובה)
        image(capture, 0, 0, screenNoseX, height, 0, 0, nx, vH);

        // --- צד ימין המשוכפל (לוקח את אותו חיתוך והופך אותו) ---
        push();
        translate(screenNoseX * 2, 0);
        scale(-1, 1);
        image(capture, 0, 0, screenNoseX, height, 0, 0, nx, vH);
        pop();
    } else {
        // --- צד ימין המקורי (נגזר מהאף ימינה) ---
        let rightW_source = vW - nx;
        let rightW_screen = rightW_source * s;
        image(capture, screenNoseX, 0, rightW_screen, height, nx, 0, rightW_source, vH);

        // --- צד שמאל המשוכפל ---
        push();
        translate(screenNoseX * 2, 0);
        scale(-1, 1);
        image(capture, screenNoseX, 0, rightW_screen, height, nx, 0, rightW_source, vH);
        pop();
    }

    // קו סימטריה שנדבק לאף
    stroke(0, 255, 0);
    strokeWeight(3);
    line(screenNoseX, 0, screenNoseX, height);
    pop();
}

function touchStarted() { if (capture) capture.elt.play(); }
function windowResized() { resizeCanvas(windowWidth, windowHeight); }
</script>

<div id="ui">
    <button onclick="mode='left'">שכפל חצי שמאל</button>
    <button onclick="mode='right'">שכפל חצי ימין</button>
</div>
</body>
</html>
